#!/usr/bin/env bash
set -e

echo "ğŸ” Running pre-commit checks..."

schema_file="AI_Talent_Schema_Rules.md"
schema_hash_file=".schema_hash"

# 1ï¸âƒ£ Extract canonical column names from schema table (Column Name = field 3)
canonical_cols=$(awk -F'|' '
/^\|[[:space:]]*\*\*[0-9]+\*\*/ {
  col=$3
  gsub(/\*\*/,"",col)
  gsub(/^[[:space:]]+|[[:space:]]+$/,"",col)
  if (col != "" && col != "Column Name" && col != "---") print col
}
' "$schema_file" | tr '\n' ',' | sed 's/,$//')

if [ -z "$canonical_cols" ]; then
  echo "âš ï¸  No canonical columns detected in $schema_file"
else
  echo "ğŸ“˜ Canonical columns detected:"
  echo "$canonical_cols"
fi

# 2ï¸âƒ£ Schema hash drift check
current_hash=$(shasum "$schema_file" | awk '{print $1}')
if [ -f "$schema_hash_file" ]; then
  last_hash=$(cat "$schema_hash_file")
  if [ "$last_hash" != "$current_hash" ]; then
    echo "âš ï¸  Schema drift detected!"
  else
    echo "âœ… Schema unchanged."
  fi
else
  echo "â„¹ï¸  Creating initial schema hash record."
fi
echo "$current_hash" > "$schema_hash_file"
git add "$schema_hash_file"

# 3ï¸âƒ£ CSV schema validation
for csv in $(git diff --cached --name-only | grep '^output/intelligence/.*\.csv$' || true); do
  echo "ğŸ“Š Validating $csv"
  header=$(head -n 1 "$csv" | tr -d '\r' | sed 's/[[:space:]]//g')
  expected=$(echo "$canonical_cols" | sed 's/[[:space:]]//g')

  if [ "$header" != "$expected" ]; then
    echo "âŒ Schema mismatch in $csv"
    echo "Expected: $expected"
    echo "Found:    $header"
    exit 1
  fi
done

echo "âœ… All pre-commit checks passed."
